<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Pet_Care_Assistant.ViewModels"
             xmlns:models="clr-namespace:Pet_Care_Assistant.Models"
             x:Class="Pet_Care_Assistant.Views.HealthCheckerPage"
             Title="Health Checker">

    <ContentPage.BindingContext>
        <viewmodels:HealthCheckerViewModel />
    </ContentPage.BindingContext>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="10">

            <Label Text="Quick Health Checker" 
                   FontAttributes="Bold" 
                   FontSize="22" 
                   HorizontalOptions="Center" 
                   Margin="0,10,0,10" 
                   TextColor="{StaticResource Primary}"/>

            <Border Stroke="{StaticResource Gray200}" 
                    StrokeThickness="1" 
                    Padding="10" 
                    Margin="0,0,0,10"
                    BackgroundColor="{StaticResource Gray100}"
                    StrokeShape="RoundRectangle 10,10,10,10">
                <VerticalStackLayout Spacing="5">

                    <SearchBar Placeholder="Search conditions..." 
                               Text="{Binding SearchText}" />

                    <Picker Title="Filter by severity..." 
                            SelectedIndex="{Binding SeverityFilterIndex}">
                        <Picker.ItemsSource>
                            <x:Array Type="{x:Type x:String}">
                                <x:String>All</x:String>
                                <x:String>Mild</x:String>
                                <x:String>Moderate</x:String>
                                <x:String>Emergency</x:String>
                            </x:Array>
                        </Picker.ItemsSource>
                    </Picker>

                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="15" Margin="0,10,0,0">
                        <Label Text="Animal type:" VerticalOptions="Center"/>

                        <RadioButton Content="Dog" 
                                     GroupName="AnimalType" 
                                     IsChecked="True"
                                     CheckedChanged="AnimalType_CheckedChanged" />

                        <RadioButton Content="Cat" 
                                     GroupName="AnimalType"
                                     CheckedChanged="AnimalType_CheckedChanged" />
                    </HorizontalStackLayout>

                </VerticalStackLayout>
            </Border>

            <CollectionView ItemsSource="{Binding DisplayedConditions}" SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Condition">

                        <Border Margin="5" Padding="0" StrokeShape="RoundRectangle 10,10,10,10"
                                BackgroundColor="White"
                                Stroke="{Binding SeverityColor}" 
                                StrokeThickness="2">

                            <VerticalStackLayout>

                                <Grid ColumnDefinitions="Auto, *, Auto" Padding="15" ColumnSpacing="15">
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleExpandCommand}"/>
                                    </Grid.GestureRecognizers>

                                    <Image Grid.Column="0" 
                                           Source="{Binding ImageUrl}" 
                                           HeightRequest="50" 
                                           WidthRequest="50" 
                                           Aspect="AspectFit"/>

                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                        <Label Text="{Binding Name}" 
                                               FontSize="16" 
                                               FontAttributes="Bold" 
                                               TextColor="{StaticResource Primary}" />
                                        <Label Text="{Binding Description}" 
                                               FontSize="12" 
                                               TextColor="{StaticResource Gray700}" 
                                               LineBreakMode="TailTruncation"/>
                                    </VerticalStackLayout>

                                    <HorizontalStackLayout Grid.Column="2" HorizontalOptions="End" VerticalOptions="Center" Spacing="5">

                                        <VerticalStackLayout HorizontalOptions="End" VerticalOptions="Center">
                                            <Label Text="{Binding Urgency}" 
                                                   FontSize="Small" 
                                                   FontAttributes="Bold" 
                                                   TextColor="{Binding SeverityColor}" 
                                                   HorizontalOptions="Center" />
                                            <Label Text="Tap for details" 
                                                   FontSize="Micro" 
                                                   TextColor="{StaticResource Secondary}"/>
                                        </VerticalStackLayout>

                                        <Image x:Name="ExpandIndicator"
                                               Source="arrow_down.png"
                                               HeightRequest="15" 
                                               WidthRequest="15"
                                               VerticalOptions="Center">

                                            <Image.Triggers>
                                                <DataTrigger TargetType="Image" 
                                                             Binding="{Binding IsExpanded}" 
                                                             Value="True">
                                                    <Setter Property="Rotation" Value="180" />
                                                </DataTrigger>
                                            </Image.Triggers>
                                        </Image>

                                    </HorizontalStackLayout>

                                </Grid>

                                <VerticalStackLayout x:Name="DetailsSection" 
                                      IsVisible="{Binding IsExpanded}" 
                                      Padding="15, 0, 15, 15" 
                                      BackgroundColor="{StaticResource Gray100}">

                                    <VerticalStackLayout Spacing="10">
                                        <Label Text="Immediate Action:" 
                                               FontAttributes="Bold" 
                                               TextColor="{StaticResource Primary}" 
                                               Margin="0,5,0,0"/>
                                        <Label Text="{Binding RecommendedAction}" 
                                               FontAttributes="Italic" 
                                               TextColor="Black"/>

                                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}"/>

                                        <Label Text="Medical Details:" 
                                               FontAttributes="Bold" 
                                               TextColor="{StaticResource Primary}"/>
                                        <Label Text="{Binding DetailsContent}" 
                                               TextColor="Black" 
                                               LineHeight="1.4"/>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>

                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
